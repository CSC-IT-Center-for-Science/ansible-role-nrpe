---
- name: Download git repos
  git:
    repo: "{{ item.src }}"
    dest: "{{ item.dest }}"
    version: "{{ item.version }}"
    force: "{{ item.force |default(True) }}"
    verify_commit: "{{ item.verify_commit | default(False) }}"
  with_items: "{{ nrpe_git_repos }}"
  when: item.type == 'git'

- name: Default nrpe command argument when nagios_dont_blame is true
  set_fact:
    default_argument: "$ARG1$"
  when: nagios_dont_blame == true
- name: Default nrpe command argument when nagios_dont_blame is false
  set_fact:
    default_argument: ""
  when: nagios_dont_blame == false

- name: Create check file
  set_fact:
    git_nrpe_checks: "{{ git_nrpe_checks |default([]) }} + [ 'command[{{ item[1].command |default( item[1].script_name )}}]={{ item[0].script_path }}{{ item[1].script_name |default( item[1].command ) }} {{ item[1].arguments |default( default_argument  ) }}' ]"
  with_subelements:
     - "{{ nrpe_git_repos }}"
     - commands
